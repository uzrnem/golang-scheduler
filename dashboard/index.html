<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Golang Scheduler — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <style>
    :root { --bg:#0b0f17; --card:#121826; --muted:#9aa4b2; --text:#e6e8eb;
            --ok:#23c55e; --warn:#f59e0b; --fail:#ef4444; --accent:#6ea8fe;
            --border:#22304a; }
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,-apple-system,Segoe UI,Roboto,sans-serif;}
    header{padding:18px 22px;border-bottom:1px solid var(--border);}
    header h1{margin:0;font-size:18px;font-weight:600;}
    h3{margin:0 0 12px;font-size:16px;font-weight:600;}
    .wrap{padding:22px;display:grid;gap:18px;grid-template-columns:360px 1fr;align-items:start;}
    @media(max-width:1000px){.wrap{grid-template-columns:1fr;}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;}
    .toolbar{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:8px;}
    .flex{display:flex;gap:8px;align-items:center;}
    input, select, button { width: 100%; padding: 10px 12px; border-radius: 10px;
      border: 1px solid var(--border); background: #0e1422; color: var(--text); }
    .btn{cursor:pointer;font-weight:600;background:#142135;border:1px solid #283753;border-radius:8px;color:var(--text);}
    .btn:hover{background:#182a47;}
    .btn-primary{background:#274b8a;border-color:#355fa7;}
    .btn-primary:hover{background:#2f5ca6;}
    .hint{color:var(--muted);font-size:12px;}
    input,select,textarea{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#0e1422;color:var(--text);}
    textarea{resize:vertical;}
    .tasks{max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px;}
    .task-item{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;}
    .task-item.active{background:#172134;}
    .task-name{font-weight:600;}
    .task-sub{font-size:12px;color:var(--muted);margin-top:2px;word-break:break-all;}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700;}
    .pill.ok{background:#0d2c1a;color:var(--ok);border:1px solid #174d2b;}
    .pill.warn{background:#2b240b;color:var(--warn);border:1px solid #5f4d14;}
    .pill.fail{background:#2e1212;color:var(--fail);border:1px solid #5a2323;}
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1000;}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;width:400px;max-width:95%;}
    label { display: block; font-size: 12px; color: var(--muted); margin: 6px 0 6px; }
    .pagination { display: flex; gap: 8px; align-items: center; }
    .small { font-size: 12px; }
    .nowrap { white-space: nowrap; }
    .mt12 { margin-top: 12px; }
  </style>
</head>
<body>
<div id="app">
  <header><h1>Golang Scheduler — Dashboard</h1></header>
  <div class="wrap">
    <div class="left">
      <div class="card">
        <h3>Login</h3>
        <label>Service ID</label>
        <input v-model="service_id" />
        <label>Token</label>
        <input v-model="token" type="password" />
        <div class="flex" style="margin-top:10px">
          <button class="btn-primary" @click="saveAndLoad">Save & Load</button>
          <button class="btn" @click="clearLogin">Clear</button>
        </div>
      </div>

      <div class="card mt12">
        <h3>Your Tasks</h3>
        <div class="toolbar">
          <span class="hint">Click a task to view executions</span>
          <div class="flex">
            <button class="btn" @click="loadTasks">Refresh</button>
            <button class="btn-primary nowrap" @click="openTaskModal()">New Task</button>
          </div>
        </div>
        <div class="tasks">
          <div v-if="tasks.length===0" class="hint" style="padding:12px">No tasks found.</div>
          <div v-for="t in tasks" :key="t.id" class="task-item" :class="{active: currentTask && currentTask.id===t.id}" @click="selectTask(t)">
            <div class="task-name">{{t.name}}</div>
            <div class="task-sub">{{t.method}} · {{t.url}}</div>
            <div class="task-sub">
              Status:
              <span class="pill" :class="statusClass(t.status)">{{t.status}}</span>
            </div>
            <div class="task-sub flex" style="margin-top:6px">
              <button class="btn" @click.stop="openTaskModal(t)">Edit</button>
              <select v-model="t.status" @change.stop="updateTaskStatus(t)">
                <option value="active">active</option>
                <option value="paused">paused</option>
                <option value="disabled">disabled</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="card">
        <h3>Executions — {{ currentTask ? currentTask.name : '' }}</h3>
        <div class="toolbar">
          <div class="flex small">
            <span id="totalCount" class="muted">Total: {{ totalCount }}</span>
          </div>
          <div class="pagination">
            <button class="btn" @click="prevPage">Prev</button>
            <span class="small muted nowrap" id="pageInfo">Page {{ pageNumber + 1 }}</span>
            <button class="btn" @click="nextPage">Next</button>
            <select v-model="pageSize" title="Count per page">
              <option value="5">5</option>
              <option value="10" selected="">10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>
        <table>
          <thead><tr><th>When</th><th>Status</th><th>HTTP</th><th>Response</th></tr></thead>
          <tbody>
            <tr v-for="e in executions" :key="e.created_at">
              <td>{{ formatDate(e.created_at) }}</td>
              <td><span class="pill" :class="statusClass(e.status)">{{e.status}}</span></td>
              <td>{{e.status_code}}</td>
              <td>{{(e.response||'').slice(0,120)}}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div v-if="showModal" class="modal-overlay">
    <div class="modal">
      <h3>{{ editingTask ? 'Edit Task' : 'New Task' }}</h3>
      <label>Name</label>
      <input v-model="taskForm.name" />
      <label>URL</label>
      <input v-model="taskForm.url" />
      <label>Headers</label>
      <div v-for="(h,i) in taskForm.headers" :key="i" class="flex" style="margin-bottom:4px">
        <input v-model="h.key" placeholder="Key" />
        <input v-model="h.value" placeholder="Value" />
        <button class="btn" @click.prevent="taskForm.headers.splice(i,1)">✕</button>
      </div>
      <button class="btn small" @click.prevent="taskForm.headers.push({key:'',value:''})">+ Add Header</button>
      <!-- label>Header (JSON)</label>
      <textarea v-model="taskForm.header" rows="3"></textarea -->
      <label>Payload</label>
      <textarea v-model="taskForm.payload" rows="3"></textarea>
      <label>Method</label>
      <select v-model="taskForm.method"><option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option></select>
      <label>Status</label>
      <select v-model="taskForm.status"><option value="active">active</option><option value="paused">paused</option><option value="disabled">disabled</option></select>
      <label>Scheduled At</label>
      <input type="datetime-local" v-model="taskForm.scheduled_at" />
      <label>Frequency</label>
      <input type="number" min="1" v-model.number="taskForm.frequency" />
      <label>Unit</label>
      <select v-model="taskForm.unit"><option value="hour">hour</option><option value="day">day</option></select>
      <div class="flex" style="margin-top:12px">
        <button class="btn-primary" @click="saveTask">Save</button>
        <button class="btn" @click="showModal=false">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
const { createApp } = Vue;
createApp({
  data(){
    return {
      service_id: localStorage.getItem('service_id')||'',
      token: localStorage.getItem('token')||'',
      tasks: [],
      currentTask: null,
      executions: [],
      pageNumber: 0,
      pageSize: 10,
      totalCount: 0,
      showModal: false,
      editingTask: null,
      taskForm: {name:'',url:'',header:'{}', headers:[{key:'',value:''}],payload:'',method:'GET',status:'active',scheduled_at:'',frequency:1,unit:'hour'},
    }
  },
  mounted(){
    if(this.service_id && this.token) this.loadTasks();
  },
  methods:{
    authHeaders(){
      return {'service_id':this.service_id,'token':this.token,'Content-Type':'application/json'};
    },
    async fetchJSON(url,opts={}){
      const res=await fetch(url,{...opts,headers:{...this.authHeaders(),...(opts.headers||{})}});
      if(!res.ok) throw new Error(await res.text()||res.statusText);
      return res.json();
    },
    saveAndLoad(){
      localStorage.setItem('service_id',this.service_id);
      localStorage.setItem('token',this.token);
      this.loadTasks();
    },
    clearLogin(){
      localStorage.clear();
      this.service_id=''; this.token=''; this.tasks=[]; this.executions=[];
    },
    statusClass(s){
      s=(s||'').toLowerCase();
      if(s==='active'||s==='success'||s==='completed') return 'ok';
      if(s==='paused'||s==='started') return 'warn';
      if(s==='disabled'||s==='failed'||s==='error') return 'fail';
      return 'warn';
    },
    formatDate(v){ return v? new Date(v).toLocaleString():''; },
    async loadTasks(){
      try{
        this.tasks = await this.fetchJSON('/tasks');
        if(!this.currentTask && this.tasks.length){
          this.selectTask(this.tasks[0]);
        }
      }catch(e){alert(e.message);}
    },
    selectTask(t){
      this.currentTask=t;
      this.pageNumber=0;
      this.pageSize=10;
      this.loadExecutions();
    },
    async loadExecutions(){
      if(!this.currentTask) return;
      try{
        const data = await this.fetchJSON(`/tasks/${this.currentTask.id}/executions?pageNumber=${this.pageNumber}&count=${this.pageSize}`);
        this.executions = data.records || [];
        this.totalCount = data.total_count || 0;
        console.log('pageNumber: ', this.pageNumber, 'pageSize:', this.pageSize, 'totalCount:', this.totalCount);
      }catch(e){alert(e.message);}
    },
    prevPage(){
      if(this.pageNumber>0){this.pageNumber--;this.loadExecutions();}
    },
    nextPage(){
      if (this.pageNumber > 0 && ((this.pageNumber + 1) * this.pageSize >= this.totalCount)) return;
      this.pageNumber++;this.loadExecutions();
    },
    openTaskModal(t=null){
      this.editingTask = t;
      if(t){
        this.taskForm = {
          ...t,
          headers: Object.entries(t.header || {}).map(([k,v]) => ({key:k,value:v})),
          scheduled_at: t.scheduled_at ? t.scheduled_at.slice(0,16) : ''
        };
      } else {
        this.taskForm = {name:'',url:'',headers:[{key:'',value:''}],payload:'',method:'GET',status:'active',scheduled_at:'',frequency:1,unit:'hour'};
      }
      this.showModal = true;
    },
    async saveTask(){
      try{
        // Convert header array → object
        const headerObj = {};
        (this.taskForm.headers || []).forEach(h=>{
          if(h.key) headerObj[h.key] = h.value;
        });

        // Format datetime
        let scheduled_at = '';
        if(this.taskForm.scheduled_at){
          const d = new Date(this.taskForm.scheduled_at);
          scheduled_at = d.toISOString().replace(/\.\d{3}Z$/,"Z"); // => YYYY-MM-DDTHH:MM:SSZ
        }

        const payload = {
          ...this.taskForm,
          header: headerObj,
          scheduled_at
        };

        if(this.editingTask){
          await this.fetchJSON(`/tasks/${this.editingTask.id}`,{method:'PUT',body:JSON.stringify(payload)});
        }else{
          await this.fetchJSON(`/tasks`,{method:'POST',body:JSON.stringify(payload)});
        }

        this.showModal = false;
        this.loadTasks();
      }catch(e){alert(e.message);}
    },
    async updateTaskStatus(t){
      try{
        await this.fetchJSON(`/tasks/${t.id}`,{method:'PUT',body:JSON.stringify(t)});
      }catch(e){alert(e.message);}
    }
  }
}).mount('#app');
</script>
</body>
</html>
